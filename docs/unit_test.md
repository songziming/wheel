# OS 单元测试

运行在 host 环境下，链接 libc、libstdc++。

## 同名函数

某些内核函数与 libc 里面的函数重名，链接会出错。如果定义为若符号，也会被 libc 函数覆盖，导致内核函数无法测试。

解决方案：

- 使用 C++ 编写测试函数，将内核头文件包含在命名空间中
- 使用 attribute alias 定义别名，在测试函数中使用别名

## 同名头文件

某些内核头文件与标准库头文件同名，导致 include 出错。常见于 C++ 文件，因为 STL 头文件更复杂，更可能与内核头文件重名。

解决方案：

限制 C++ 源文件的 include path，禁止其引用内核头文件。

如果还不行，就把代码分为两部分：能引用内核头文件的不能引用标准库，能使用标准库的不能引用内核头文件。这两部分通过本地头文件通信。

## Mocking

有些函数不需要测试，但是会被待测函数调用，例如自旋锁、物理页分配释放。

我们可以在 mock 文件中提供替代实现。
