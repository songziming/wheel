# 软件锁相环（SW-PLL）

锁相环可用于同步时钟、控制相位。

使用 8254 PIT 校准 Local APIC Timer 就可以使用锁相环，控制每个 CPU 的时钟中断相位差异也可以使用锁相环。

让各个 CPU 的时钟中断发生时间错位，可以避免数据竞争。


### 锁相环

PLL 基本原理如下：

参考信号 --> 相位比较器 --> 低通滤波器 --> 压控振荡器 --> 输出
                ^                           |
                |                           |
                +---------------------------+

相位比较器可以计算两个输入信号的相位差异，相位差异越大，输出电压越高。
最简单的相位比较器就是异或门，如果信号都是方波，则两个信号异或，输出中“1”的占比就是差异大小。

相位比较器输出是 PWM 信号，并不是一个平稳的电压，因此需要一个低通滤波器将不稳定的输入平均下来。

压控振荡器输出震荡信号，频率由输入电压控制。振荡器有一个中心频率，在此基础上受输入电压影响调整。

这样就形成了一个控制回路，经过一段时间就会收敛稳定下来。稳定时，输出信号和参考信号频率相同，相位固定，比较器经低通输出稳定。

### 软件锁相环

AOSP SurfaceFlinger DispSync 就是软件锁相环，用来产生 VSYNC、SF_VSYNC 信号。
代码位于 aosp/frameworks/native/services/surfaceflinger/Scheduler
