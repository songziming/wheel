# 单元测试

内核的单元测试要复杂一些，因为开发环境和执行环境区别很大。

如果在虚拟机上运行测试，则缺少代码覆盖率统计和调试支持；如果在开发环境下测试，则无法完全模拟实际执行环境，并可能与标准库符号冲突。

Linux 提供了 KUnit 单元测试框架，系统启动后执行，但使用得不多。

我们可以两种策略都支持，开发初期在 host 环境测试，便于利用方便的调试手段

## 在 host 环境运行

单元测试程序由两部分目标文件链接在一起：
- 来自 kernel 的源码，使用 x86_64-px-none-elf 编译，开启 LTO
- 来自 kernel_test 的源码，使用默认的 x86_64-unknown-linux-gnu 编译，关闭 LTO

内核源码需要去掉汇编文件，因为汇编文件有 32-bit 代码，只有 C 文件编译之后才是纯 64 位。

测试用例文件放在 kernel_test 目录下，与内核代码分开。

## 在目标硬件上运行

系统启动之后，在真实环境下运行。此时难点在于如何统计代码覆盖率，生成测试结果报告，需要在虚拟机和宿主机之间通信。

如果我们的 OS 支持文件系统，可以把测试结果保存到磁盘上。

- 优点：真机上也能执行测试
- 缺点：需要不少的支持代码，无法利用 host 环境下的第三方库，无法统计代码覆盖率

可以通过 GRUB 传入参数，告知内核需要执行测试，测试完成后通过 qemu debug-exit 设备退出虚拟机，这样也可以实现自动化测试。

